<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="iOS, Objective-C, Swift"><title>Method Swizzling - yuejieee's Blog</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/yuejieee"><span>Github</span></a></li><li><a href="http://weibo.com/u/3645434183"><span>Weibo</span></a></li><li><a href="http://cn.engadget.com/"><span>Engadget</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title">Method Swizzling</h1><ul class="meta"><li><i class="icon icon-author"></i>yuejieee</li><li><i class="icon icon-clock"></i>4 Minutes</li><li><i class="icon icon-calendar"></i>April 17, 2017</li></ul></div></div><div class="article-content" style="max-width:800px"><h2 id="Method-Swizzling简介"><a href="#Method-Swizzling简介" class="headerlink" title="Method Swizzling简介"></a>Method Swizzling简介</h2><p>Method Swizzling是Runtime一个重要的特性，在项目开发过程中我们可以创建类别来为系统类来添加一些额外的方法，可以通过重写来重新实现一些系统的方法，但是如果我们想为系统的类已有的方法中添加一些实现，而不是完全替换这个方法的实现，这就需要用到Method Swizzling。<br><a id="more"></a></p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>在之前Runtime的文章中说过，每个Class结构体中都有一个方法分发表的成员变量，而这个方法分发表中包含的就是每个SEL（方法名）对应的IMP（方法实现，指向C函数的指针），Method Swizzling要做的就是将每个方法的SEL和IMP解开，并关联到我们指定的IMP。</p>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">@implementation ViewController (Log)</div><div class="line"></div><div class="line">+ (void)load &#123;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        swizzlingMethod(self, @selector(viewWillAppear:), @selector(swizzled_viewWillAppear:));</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)swizzled_viewWillAppear:(BOOL)animated &#123;</div><div class="line">    [self swizzled_viewWillAppear:animated];</div><div class="line"></div><div class="line">    NSLog(@&quot;Current Class: %@&quot;, NSStringFromClass([self class]));</div><div class="line">&#125;</div><div class="line"></div><div class="line">void swizzlingMethod(Class class, SEL originalSelector, SEL swizzledSelector) &#123;</div><div class="line">    Method originalMethod = class_getInstanceMethod(class, originalSelector);</div><div class="line">    Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);</div><div class="line"></div><div class="line">    BOOL didAddMethod = class_addMethod(class, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</div><div class="line">    if (didAddMethod) &#123;</div><div class="line">        class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</div><div class="line">    &#125; else &#123;</div><div class="line">        method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码应该比较容易理解，就是替换了系统的<code>viewWillAppear:</code>方法，为其中添加了一行打印当前类名的代码。<br>其中有几个点需要特别解释一下：</p>
<ul>
<li><code>class_addMethod()</code>这个方法主要是判断是否能为当前类添加方法，避免这个方法没有实现的问题：<ol>
<li>未添加成功，就直接将两个方法的实现交换就可以了。</li>
<li>添加成功，就说明当前类没有实现该方法，而是继承了父类的实现，我们利用class_replaceMethod将父类的实现添加到我们当前类的要交换的方法的实现中。</li>
</ol>
</li>
<li>在<code>+load</code>方法中调用swizzling方法，因为Runtime会自动调用<code>+load</code>、<code>+initialize</code>两个类方法，<code>+load</code>是在类加载时调用的，<code>+initialize</code>是在类或其实例收到第一条对象时调用，也就是<code>懒加载</code>，所以在<code>+load</code>方法中调用是最合适的。</li>
<li>为什么要用dispatch_once，虽然Runtime只会调用<code>+load</code>一次，但是为了防止手动调用<code>+load</code>时导致swizzling发生错误，所以要用dispatch_once来处理。</li>
</ul>
</div><div class="article-meta" style="max-width:800px"><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Objective-C/">Objective-C</a><span class="category-list-count">9</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2017/04/14/在Category中添加属性/"><i class="icon icon-arror-left"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/yuejieee" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.com/u/3645434183" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="http://oltlcmelj.bkt.clouddn.com/WechatQRCode.jpeg" title="Wechat" target="_blank"><i class="icon icon-wechat"></i></a></li><li><a href="mailto:yuejieee@gmail.com" title="Email" target="_blank"><i class="icon icon-email"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2017 yuejieee's Blog<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>